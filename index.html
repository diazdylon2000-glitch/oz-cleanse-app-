<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Oz Cleanse Companion ‚Äî V14</title>
  <meta name="theme-color" content="#f9c2a7"/>

  <!-- React + Chart.js with fallbacks (do not change) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"
          crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js'"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
          crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"
          onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.3/dist/chart.umd.js'"></script>

  <!-- V14 look & feel -->
  <style>
    :root{
      --peach:#ffb08f; --peach-200:#ffd8c8; --peach-100:#fff1ea;
      --rose:#ec4899; --ink:#334155; --line:#f3d0e1; --chip:#ffe4ef;
      --cream:#fff7f1; --shadow:0 8px 24px rgba(236,72,153,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--cream);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2{margin:0 0 8px 0}
    .wrap{max-width:940px;margin:16px auto 96px;padding:0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .badge{display:inline-block;padding:2px 10px;border:1px solid #e7ccd7;background:#fff;border-radius:9999px;font-size:12px}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer}
    .btn.peach{background:linear-gradient(90deg,#ffc7a9,#ffe1d6);border-color:#ffd9c8}
    .grid{display:grid;gap:16px}
    @media(min-width:760px){.grid-3{grid-template-columns:repeat(3,1fr)}}

    /* Pills + paw checks */
    .pill{border-radius:9999px;padding:.45rem .8rem;border:1px solid #ffd8be;background:#fff;transition:transform .12s}
    .pill.on{background:linear-gradient(90deg,#ffc79d,#ffd8be)}
    .paw{display:inline-flex;align-items:center;justify-content:center;height:36px;width:36px;border-radius:9999px;border:1px solid #f0cbb0;background:#fff;transition:transform .12s, background .2s;cursor:pointer}
    .paw.on{background:linear-gradient(90deg,#f9d49a,#ffd2c8);transform:scale(1.02)}

    /* Progress bars */
    .prog{height:10px;border-radius:9999px;background:#fde7e0;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#ffa56e,#ec4899);width:0;transition:width .35s ease}

    /* Bottom tabs */
    .tabs{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:8px;background:#fff;border-top:1px solid var(--line)}
    .tabs .btn{flex:1}
    .tabs .btn.active{background:var(--chip)}

    /* Toast + snack */
    .toast{position:fixed;left:12px;right:12px;top:18px;z-index:60}
    .toast>div{background:linear-gradient(90deg,#ffe4ef,#e9d5ff);border:1px solid var(--line);border-radius:16px;padding:10px;box-shadow:0 12px 30px rgba(236,72,153,.15)}
    .snack{position:fixed;left:12px;right:12px;bottom:16px;z-index:70}
    .snack>div{background:#1f2937;color:#fff;border-radius:14px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}

    /* Splash with Oz + speech bubble */
    #errorBanner{display:none;position:fixed;top:0;left:0;right:0;background:#ff4d4d;color:#fff;padding:10px;font-size:14px;z-index:10000;text-align:center}
    .splash{position:fixed;inset:0;background:#fef3ec;display:flex;align-items:center;justify-content:center;z-index:80}
    .splash img{width:170px;height:170px;border-radius:9999px;object-fit:cover;border:6px solid #fff;box-shadow:0 24px 60px rgba(149,92,51,.25)}
    .bubble{position:fixed;left:50%;top:54%;transform:translateX(92px);max-width:260px;z-index:81;background:#fff;border:2px solid var(--line);border-radius:16px;box-shadow:0 10px 32px rgba(236,72,153,.15);padding:10px 12px;font-size:13px;line-height:1.25}
    .bubble:after{content:'';position:absolute;left:-10px;top:28px;border:10px solid transparent;border-right-color:var(--line)}
    .bubble:before{content:'';position:absolute;left:-8px;top:28px;border:10px solid transparent;border-right-color:#fff;z-index:1}
    .fadeOut{animation:fadeOut .6s ease forwards}
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}

    /* Header row */
    header.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header.hdr img{height:36px;width:36px;border-radius:9999px;object-fit:cover}
  </style>
</head>
<body>
  <!-- Error banner shows any JS crash with line:col -->
  <div id="errorBanner"></div>

  <!-- Splash -->
  <div id="ozSplash" class="splash"><img id="ozImg" alt="Oz"/></div>
  <div id="ozBubble" class="bubble">Loading‚Ä¶</div>

  <!-- App root -->
  <div id="root" style="display:none"></div>

  <!-- Splash failsafe + error capture -->
  <script>
    (function(){
      // Always hide splash after 3s even if React fails
      setTimeout(function(){
        var s=document.getElementById('ozSplash'); if(s) s.classList.add('fadeOut');
        var b=document.getElementById('ozBubble'); if(b) b.classList.add('fadeOut');
        setTimeout(function(){
          if(s) s.style.display='none';
          if(b) b.style.display='none';
          var root=document.getElementById('root'); if(root) root.style.display='block';
        },620);
      },3000);
      // Show errors on screen
      window.addEventListener('error',function(e){
        var el=document.getElementById('errorBanner');
        el.textContent='Error: '+(e.error&&e.error.message?e.error.message:e.message);
        el.style.display='block';
      });
    })();
  </script>

  <!-- Affirmations + Oz image init -->
  <script>
    (function(){
      try{
        var oz=document.getElementById('ozImg');
        oz.src='oz.png'; // replace with your real Oz photo filename later if different

        var A=[
          "You‚Äôve got this, one sip at a time!",
          "Strong body, strong mind‚Äîkeep going!",
          "Hydration is happiness. üêæ",
          "Fuel today, flourish tomorrow.",
          "Every sip is a promise kept.",
          "Gentle and steady wins.",
          "You‚Äôre lighter and brighter each day.",
          "Small habits, big change.",
          "Proud of you already.",
          "Your willpower is glowing.",
          "Keep moving; you‚Äôre unstoppable!",
          "Oz is rooting for you!",
          "Cleansing with kindness.",
          "Sip, breathe, reset.",
          "You crave what nourishes you.",
          "Consistency over intensity.",
          "You‚Äôre building momentum.",
          "Energy rising, mind clear.",
          "Hydrate like a champ.",
          "Today‚Äôs choices shape tomorrow.",
          "Progress, not perfection.",
          "Tiny wins stack up.",
          "You‚Äôre doing amazing.",
          "Cheers to your health.",
          "Own your routine.",
          "Steady heart, steady steps.",
          "Let it be simple.",
          "Flow with it; you‚Äôre good.",
          "Trust your pace.",
          "Shine from within."
        ];
        // Cycle without repeats
        var used=JSON.parse(localStorage.getItem('oz_aff_used')||'[]');
        var avail=A.filter(function(t){return used.indexOf(t)===-1;});
        if(avail.length===0){avail=A;used=[];}
        var pick=avail[Math.floor(Math.random()*avail.length)];
        used.push(pick); localStorage.setItem('oz_aff_used',JSON.stringify(used));
        var bubble=document.getElementById('ozBubble'); if(bubble) bubble.textContent=pick;
      }catch(err){
        var el=document.getElementById('errorBanner');
        el.textContent='Init error: '+err.message;
        el.style.display='block';
      }
      // Hide splash a bit earlier when window fully loads
      window.addEventListener('load',function(){
        setTimeout(function(){
          var s=document.getElementById('ozSplash'); var b=document.getElementById('ozBubble');
          if(s) s.classList.add('fadeOut'); if(b) b.classList.add('fadeOut');
          setTimeout(function(){
            if(s) s.style.display='none'; if(b) b.style.display='none';
            var root=document.getElementById('root'); if(root) root.style.display='block';
          },620);
        },1400);
      });
    })();
  </script>
  <!-- React App -->
  <script>
    const e = React.createElement;
    const { useState, useEffect } = React;
  // --- localStorage state helper ---
  function useLocal(key, initialValue){
    const [val, setVal] = React.useState(() => {
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
      catch { return initialValue; }
    });
    React.useEffect(() => {
      try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }, [key, val]);
    return [val, setVal];
  }

    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      var base = (d.order && d.order.length ? d.order.slice() : templateIds.slice());
      base.push("lmnt");
      d.order = base;     // becomes a custom day now
      d.custom = true;
      if(!d.checks) d.checks = {};
      d.checks.lmnt = false;
      next[idx] = d;
      return next;
    });
  }


  // Default template order (used for first-time load / migration)
  const DEFAULT_PHASE_TEMPLATES = {
    fast:    ["water","tea","coffee","lmnt","exercise","weight"],
    cleanse: ["water","tea","coffee","juice","lmnt","exercise","weight"],
    rebuild: ["water","lmnt","exercise","wholefood","weight"]
  };
  
    // Animated progress bar
    const ProgressBar = ({ value }) =>
      e("div", { className: "prog" },
        e("div", { className: "fill", style: { width: value + "%" } })
      );

    // Checklist with paw toggles
    const Checklist = ({ items, state, setState }) =>
      e("ul", { style: { listStyle: "none", padding: 0 } },
        items.map(item =>
          e("li", { key: item.id, style: { margin: "8px 0", display: "flex", alignItems: "center" } },
            e("div", {
              className: "paw" + (state[item.id] ? " on" : ""),
              onClick: () => setState({ ...state, [item.id]: !state[item.id] })
            }, "üêæ"),
            e("span", { style: { marginLeft: "8px" } }, item.label)
          )
        )
      );

  // Mini weight chart with live updates and cleanup
const WeightChart = ({ series }) => {
  const canvasRef = React.useRef(null);
  const chartRef = React.useRef(null);

  React.useEffect(() => {
    const ctx = canvasRef.current.getContext("2d");
    if (chartRef.current) chartRef.current.destroy();

    chartRef.current = new Chart(ctx, {
      type: "line",
      data: {
        labels: series.map((_, i) => "Day " + (i + 1)),
        datasets: [{
          data: series,
          borderColor: "#ec4899",
          backgroundColor: "rgba(236,72,153,.15)",
          tension: 0.35,
          spanGaps: true,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { ticks: { callback: v => v || "" } } },
        animation: { duration: 200 }
      }
    });

    return () => { try { chartRef.current && chartRef.current.destroy(); } catch(e){} };
  }, [series]);

  return React.createElement("canvas", { ref: canvasRef, height: 120 });
};

    // Grocery list with day tags + total
    const GroceryList = ({ items }) => {
      const [checked, setChecked] = useState({});
      const total = items.reduce((sum, it) => sum + (checked[it.name] ? 0 : it.price), 0);
      return e("div", {},
        e("div", { style: { fontWeight: "bold", marginBottom: "8px" } }, `Total: $${total.toFixed(2)}`),
        e("ul", { style: { listStyle: "none", padding: 0 } },
          items.map(it =>
            e("li", { key: it.name, style: { display: "flex", alignItems: "center", margin: "6px 0" } },
              e("input", {
                type: "checkbox",
                checked: !!checked[it.name],
                onChange: () => setChecked({ ...checked, [it.name]: !checked[it.name] })
              }),
              e("span", { style: { flex: 1, marginLeft: "8px" } }, `${it.name} ‚Äî Day ${it.day}`),
              e("span", { style: { fontSize: "0.85em", color: "#666" } }, `$${it.price.toFixed(2)}`)
            )
          )
        )
      );
    };

// Dashboard ‚Äî per-day customization + progress from real goals
const Dashboard = ({ templates, days, setDays }) => {
  const [idx, setIdx] = useState(0); // current day index (0-based)

  const day = days[idx] || days[0];

  // weight series for chart (nulls allowed for missing days)
  const weightSeries = days.map(function(d){ return (d.weight==null ? null : d.weight); });

  const templateIds = templates[day.phase] || [];
  const activeIds = (day.order && day.order.length ? day.order : templateIds);
const activeIds = (day.order && day.order.length ? day.order : templateIds);

function lmntQuickAdd(){
  if (activeIds.includes("lmnt")) {
    alert("LMNT is already on today‚Äôs checklist.");
    return;
  }
  setDays(prev => {
    let next = prev.slice();
    let d = { ...next[idx] };
    let base = d.order?.length ? [...d.order] : [...templateIds];
    base.push("lmnt");
    d.order = base;
    d.custom = true;
    d.checks = { ...d.checks, lmnt: false };
    next[idx] = d;
    return next;
  });
}
  const items = activeIds.map(function(id){
    return { id:id, label: GOAL_LIBRARY[id] || id };
  });

  const checks = day.checks || {};
  const doneCount = items.reduce(function(acc, it){ return acc + (checks[it.id] ? 1 : 0); }, 0);
  const totalCount = Math.max(1, items.length);
  const progress = (doneCount / totalCount) * 100;

  function toggleCheck(id){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      var c = Object.assign({}, d.checks);
      c[id] = !c[id];
      d.checks = c;
      next[idx] = d;
      return next;
    });
  }

  function setPhase(p){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.phase = p;
      next[idx] = d;
      return next;
    });
  }

  // LMNT quick-add (lives INSIDE Dashboard so it can see variables)
  function lmntQuickAdd(){
    if (activeIds.indexOf("lmnt") !== -1) {
      alert("LMNT is already on today‚Äôs checklist.");
      return;
    }
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      var base = (d.order && d.order.length ? d.order.slice() : templateIds.slice());
      base.push("lmnt");
      d.order = base;     // becomes a custom day now
      d.custom = true;
      if(!d.checks) d.checks = {};
      d.checks.lmnt = false;
      next[idx] = d;
      return next;
    });
  }

  // Customization editor (per-day)
  const [editing, setEditing] = useState(false);
  const [dragIndex, setDragIndex] = useState(null);
  const [localIds, setLocalIds] = useState(activeIds);

  useEffect(function(){ setLocalIds(activeIds); }, [idx, day.phase, day.order]);

  function applyCustom(){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.order = localIds.slice();
      d.custom = true;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }

  function resetToTemplate(){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.order = null;
      d.custom = false;
      var allowed = new Set((templates[d.phase]||[]));
      var newChecks = {};
      Object.keys(d.checks||{}).forEach(function(k){
        if(allowed.has(k)) newChecks[k]=d.checks[k];
      });
      d.checks = newChecks;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }

  function removeGoal(id){
    setLocalIds(function(prev){ return prev.filter(function(x){ return x!==id; }); });
  }
  function addGoal(){
    var pool = Object.keys(GOAL_LIBRARY).filter(function(id){ return localIds.indexOf(id)===-1; });
    if(pool.length===0){ alert("All goals already included"); return; }
    var id = prompt("Add goal by ID:\n"+pool.join(", "));
    if(!id || pool.indexOf(id)===-1) return;
    setLocalIds(function(prev){ return prev.concat([id]); });
  }
  function handleDragStart(i,e){
    setDragIndex(i);
    try{ e.dataTransfer.setData("text/plain", String(i)); }catch(_){}
  }
  function handleDrop(i,e){
    e.preventDefault();
    if(dragIndex===null || dragIndex===i) return;
    setLocalIds(function(prev){
      var arr = prev.slice();
      var mv = arr.splice(dragIndex,1)[0];
      arr.splice(i,0,mv);
      return arr;
    });
    setDragIndex(null);
  }

  function changeDay(direction){
    setIdx(function(cur){
      var n = cur + direction;
      if(n<0) n = days.length-1;
      if(n>=days.length) n = 0;
      return n;
    });
  }

  return e("div", { className:"wrap" },
    e("header", { className:"hdr", style:{gap:8}},
      e("h1", null, "Dashboard"),
      e("div", { className:"badge" },
        (day.custom ? "Custom ‚Ä¢ " : "Template ‚Ä¢ ") + day.phase.toUpperCase()
      ),
      e("div", null,
        e("button", { className:"btn", onClick:function(){ changeDay(-1); } }, "‚óÄ"),
        e("span", { className:"badge", style:{margin:"0 8px"} }, "Day "+day.day),
        e("button", { className:"btn", onClick:function(){ changeDay(1); } }, "‚ñ∂")
      ),
      e("div", null,
        e("select", {
          value: day.phase,
          onChange:function(ev){ setPhase(ev.target.value); },
          className:"btn"
        },
          e("option", {value:"fast"}, "Fast"),
          e("option", {value:"cleanse"}, "Cleanse"),
          e("option", {value:"rebuild"}, "Rebuild")
        )
      ),
      e("div", null,
        e("button", { className:"btn peach", onClick:function(){ setEditing(true); } }, "Customize Day"),
        day.custom && e("button", { className:"btn", style:{marginLeft:8}, onClick:resetToTemplate }, "Reset to Template"),
        e("button", { className:"btn", style:{marginLeft:8}, onClick: lmntQuickAdd }, "Add LMNT Today")
      )
    ),

    e(ProgressBar, { value: progress }),

    e("ul", { style:{ listStyle:"none", padding:0, marginTop:12 }},
      items.map(function(it){
        var on = !!checks[it.id];
        return e("li", { key:it.id, style:{ display:"flex", alignItems:"center", margin:"8px 0" }},
          e("div", {
            className:"paw"+(on?" on":""),
            onClick:function(){ toggleCheck(it.id); }
          }, "üêæ"),
          e("span", { style:{ marginLeft:8 } }, it.label)
        );
      })
    ),

    // Weight card (NOTE: ends with a comma to separate next sibling)
    e("div", { className:"card", style:{ marginTop:16 }},
      e("h2", null, "Weight"),
      e("div", { style:{ display:"flex", alignItems:"center", gap:8, margin:"8px 0" } },
        e("label", null, "Today‚Äôs weight"),
        e("input", {
          type:"number",
          step:"0.1",
          value: (day.weight==null ? "" : day.weight),
          onChange: function(ev){
            var v = ev.target.value;
            setDays(function(prev){
              var next = prev.slice();
              var d = Object.assign({}, next[idx]);
              d.weight = (v==="" ? null : Number(v));
              next[idx] = d;
              return next;
            });
          },
          style:{ width:120 }
        }),
        e("span", { className:"badge" }, "Day "+day.day)
      ),
      e("div", { style:{ marginTop:8 } },
        e(WeightChart, { series: weightSeries })
      )
    ),

    // Customization panel
    editing && e("div", { className:"card", style:{ marginTop:16, borderColor:"#f9c2a7" }},
      e("h2", null, "Customize Day "+day.day),
      e("p", { style:{ color:"#64748b", margin:"6px 0 12px" } }, "Drag to reorder; add/remove goals just for this day."),
      e("ul", { style:{ listStyle:"none", padding:0 }},
        localIds.map(function(id, i){
          return e("li", {
              key:id, draggable:true,
              onDragStart:function(e){ handleDragStart(i,e); },
              onDragOver:function(e){ e.preventDefault(); },
              onDrop:function(e){ handleDrop(i,e); },
              style:{ display:"flex", alignItems:"center", padding:"8px", marginBottom:"6px", border:"1px solid #f3d0e1", borderRadius:"12px", background:"#fff"}
            },
            e("span", { style:{ width:18, marginRight:8, opacity:.6 } }, "‚ãÆ‚ãÆ"),
            e("span", { style:{ flex:1 } }, GOAL_LIBRARY[id] || id),
            e("button", { className:"btn", onClick:function(){ removeGoal(id); } }, "Remove")
          );
        })
      ),
      e("div", null,
        e("button", { className:"btn peach", onClick:addGoal }, "Add Goal"),
        e("button", { className:"btn", style:{ marginLeft:8 }, onClick:function(){ setEditing(false); } }, "Cancel"),
        e("button", { className:"btn", style:{ marginLeft:8 }, onClick:applyCustom }, "Save")
      )
    )
  );
};


    ReactDOM.render(e(App), document.getElementById("root"));
  </script>
</body>
</html>
