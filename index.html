<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Oz Companion</title>
  <meta name="theme-color" content="#f9c2a7"/>

  <!-- React + Chart.js + Confetti (with fallbacks) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js'"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin
          onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.3/dist/chart.umd.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" crossorigin
          onerror="this.onerror=null;this.src='https://unpkg.com/canvas-confetti@1.6.0/dist/confetti.browser.min.js'"></script>

  <style>
    :root{
      --peach:#ffb08f; --peach-100:#fff1ea; --peach-200:#ffd8c8;
      --ink:#0f172a; --sub:#64748b; --line:#f3d0e1; --chip:#ffe4ef;
      --card:#ffffff; --bg:#fff7f1;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2{margin:0 0 10px}
    small{color:var(--sub)}
    body{padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}

    /* Wrap & cards */
    .wrap{max-width:940px;margin:16px auto 96px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .badge{display:inline-block;padding:2px 10px;border:1px solid #e7ccd7;background:#fff;border-radius:9999px;font-size:12px}

    /* Masthead (peachy, clean) */
    .mast{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px}
    .mastRow{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .mastLeft{display:flex;align-items:center;gap:10px}
    .mastLeft img{height:40px;width:40px;border-radius:9999px;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 0 rgba(0,0,0,.05)}
    .mastTitle b{font-size:20px;line-height:1}
    .mastTitle small{color:var(--sub)}
    .day-nav{display:flex;align-items:center;gap:8px}
    .day-btn{appearance:none;border:2px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer}
    .day-label{font-weight:700;border:2px solid var(--line);background:#fff;border-radius:9999px;padding:6px 12px}

    /* Phase pill */
    .phaseSel{appearance:none;border:2px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px}

    /* Progress bar */
    .prog{height:10px;border-radius:9999px;background:#fde7e0;overflow:hidden;margin-top:12px}
    .fill{height:100%;background:linear-gradient(90deg,#ffa56e,#ec4899);width:0;transition:width .35s cubic-bezier(.22,.61,.36,1)}

    /* Paw checklist */
    .list{list-style:none;margin:0;padding:0}
    .item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--line)}
    .item:last-child{border-bottom:0}
    .paw{display:inline-flex;align-items:center;justify-content:center;height:36px;width:36px;border-radius:9999px;
      border:1.5px solid #f0cbb0;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.03);
      transition:transform .12s ease, background .2s ease, border-color .2s ease}
    .paw>span{font-size:18px;line-height:1}
    .paw.on{background:linear-gradient(180deg,#ffd8be,#ffe8da);border-color:#f6c8a3;transform:translateY(1px)}
    .item label{font-size:17px}

    /* Coach (pretty pink section) */
    .coachShell{border:1px solid var(--line);border-radius:16px;padding:12px;background:
      linear-gradient(180deg,#fff,#fff),
      radial-gradient(120% 60% at 0% 0%, #ffeaf4 0%, transparent 60%),
      radial-gradient(120% 60% at 100% 0%, #f7e6ff 0%, transparent 60%);
      background-blend-mode:normal,screen,screen}
    .coachHeader{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .coachBadge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:9999px;padding:8px 12px}
    .coachBtns{display:flex;gap:8px;margin:8px 0 10px}
    .btn{appearance:none;border:2px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .coachOut{white-space:pre-wrap;border:1px dashed var(--line);border-radius:16px;padding:12px;background:#fff}

    /* Tabs */
    .tabs{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:10px;background:#fff;border-top:1px solid var(--line)}
    .tabs .btn{flex:1;border-radius:12px}
    .tabs .btn.active{background:#111827;color:#fff;border-color:#111827}
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
  "use strict";
  const e = React.createElement;
  const {useState, useEffect, useRef} = React;

  /* ------------ helpers + local storage ------------ */
  function useLocal(key, initialValue){
    const [val, setVal] = useState(() => {
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
      catch { return initialValue; }
    });
    useEffect(() => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }, [key, val]);
    return [val, setVal];
  }
  window.safeConfetti = (opts)=>{ try{ if(window.confetti) window.confetti(opts); }catch(e){} };

  /* ------------------- data ------------------- */
  const GOAL_LIBRARY = {
    water:"ðŸ’§ Drink 120â€“150 oz water",
    lmnt:"ðŸ§‚ Electrolytes",
    exercise:"ðŸƒ Exercise",
    wholefood:"ðŸ¥— Whole food meals",
    weight:"ðŸ‘£ Weight check-in"
  };

  const DEFAULT_PHASE_TEMPLATES = {
    fast:["water","lmnt","exercise","weight"],
    cleanse:["water","lmnt","exercise","weight"],
    rebuild:["water","lmnt","exercise","wholefood","weight"]
  };

  function defaultDays(){
    const phases=["fast","fast","fast","cleanse","cleanse","cleanse","cleanse","rebuild","rebuild","rebuild","rebuild"];
    return phases.map((ph,i)=>({day:i+1,phase:ph,order:null,checks:{},custom:false,note:"",weight:null,photos:[]}));
  }

  /* ------------ small UI pieces ------------ */
  const ProgressBar = ({ value }) =>
    e("div", { className:"prog" }, e("div", { className:"fill", style:{ width: Math.max(0, Math.min(100, value))+"%" } }));

  const Checklist = ({ items, state, onToggle }) =>
    e("ul", { className:"list" },
      items.map(it =>
        e("li", { key:it.id, className:"item" },
          e("button", { className:"paw"+(state[it.id]?" on":""), onClick:()=>onToggle(it.id), "aria-pressed":!!state[it.id] },
            e("span", null, "ðŸ¾")
          ),
          e("label", null, it.label)
        )
      )
    );

  const WeightChart = ({ series }) => {
    const canvasRef = useRef(null);
    const chartRef = useRef(null);
    useEffect(()=>{
      const ctx = canvasRef.current.getContext("2d");
      if(chartRef.current){ try{ chartRef.current.destroy(); }catch(e){} }
      chartRef.current = new Chart(ctx, {
        type:"line",
        data:{
          labels: series.map((_,i)=>"Day "+(i+1)),
          datasets:[{ data:series, borderColor:"#ec4899",
            backgroundColor:"rgba(236,72,153,.10)", tension:.35, spanGaps:true, pointRadius:3 }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout:{ padding:{ bottom:8 } },
          scales:{
            x:{ grid:{ display:false }, ticks:{ autoSkip:true, maxRotation:0, minRotation:0 } },
            y:{ grid:{ color:"rgba(0,0,0,.06)" }, ticks:{ callback:v=>v||"" } }
          },
          animation:{ duration:220 }
        }
      });
      return ()=>{ try{ chartRef.current && chartRef.current.destroy(); }catch(e){} };
    }, [series]);
    return e("div",{style:{height:220}}, e("canvas",{ref:canvasRef}));
  };

  /* ------------------- Smart Coach ------------------- */
  const COACH_AFFIRM = [
    "Youâ€™ve got this! ðŸ’ª","Proud of your effort today. ðŸŒŸ","Oz is wagging his tail for you! ðŸ¶",
    "One step at a time â€” youâ€™re doing amazing.","Keep going, your future self will thank you.",
    "Tiny wins add up.","Consistency beats intensity.","Youâ€™re building something real.",
    "Strong body, kind mind.","Hydration helps everything.","Breathe, sip, reset.",
    "Today counts.","I see your effort.","Momentum looks good on you.","Grace + grit."
  ];

  const COACH_RULES = [
    { id:"dizziness", tips:["Sit or lie until steady.","Small juice or a pinch of salt/electrolyte if fasting.","Breathe in 4 / out 6."] },
    { id:"headache",  tips:["Sip 8â€“12 oz water over 15 min.","Add a pinch of sea salt/electrolyte.","Dim screens 10 minutes."] },
    { id:"nausea",    tips:["Peppermint/ginger tea.","Fresh air.","Move slowly."] },
    { id:"fatigue",   tips:["15â€“20 min rest.","Hydrate or electrolytes.","2 minutes of light stretching."] },
    { id:"brain-fog", tips:["Stand and stretch.","Hydrate now.","Get 5 minutes of sunlight."] }
  ];
  const SYM_MATCHERS = [
    {id:"headache",rx:/\b(headache|migraine|head pain)\b/i},
    {id:"dizziness",rx:/\b(dizzy|light[-\s]?headed|vertigo)\b/i},
    {id:"nausea",rx:/\b(nausea|queasy|sick to (my|the) stomach)\b/i},
    {id:"fatigue",rx:/\b(tired|fatigue|exhaust(ed|ion)|wiped|low energy)\b/i},
    {id:"brain-fog",rx:/\b(brain[-\s]?fog|foggy|can.?t focus)\b/i}
  ];
  function inferMoodFrom(text){
    let score = 6;
    const t = (text||"").toLowerCase();
    const neg = [/overwhelm|anxious|stressed|down|sad|discouraged|frustrat/,/tired|exhaust|wiped|drained/,/pain|hurt|ache/]
                .reduce((n,rx)=> n+(rx.test(t)?1:0),0);
    const pos = [/proud|strong|good|better|energized|motivated|win|progress|calm|happy|light/]
                .reduce((n,rx)=> n+(rx.test(t)?1:0),0);
    score += pos - 2*neg;
    return Math.max(1, Math.min(10, score));
  }

  /* ------------------- Dashboard ------------------- */
  const Dashboard = ({ templates, days, setDays }) => {
    const [idx, setIdx] = useState(0);
    const day = days[idx] || days[0];

    // checklist
    const templateIds = templates[day.phase] || [];
    const activeIds = (day.order && day.order.length ? day.order : templateIds);
    const items = activeIds.map(id => ({ id, label: GOAL_LIBRARY[id] || id }));
    const checks = day.checks || {};
    const doneCount = items.reduce((a, it) => a + (checks[it.id] ? 1 : 0), 0);
    const totalCount = Math.max(1, items.length);
    const progress = (doneCount / totalCount) * 100;
    const weightSeries = days.map(d => (d.weight == null ? null : d.weight));

    useEffect(()=>{ if (Math.round(progress) === 100) window.safeConfetti({ particleCount: 90, spread: 70, origin: { y: .6 } }); }, [progress]);

    function toggleCheck(id){
      setDays(prev => {
        const next = prev.slice();
        const d = { ...next[idx] };
        const c = { ...(d.checks || {}) };
        c[id] = !c[id];
        d.checks = c;
        next[idx] = d;
        return next;
      });
    }
    function setPhase(p){
      setDays(prev => { const next = prev.slice(); const d = { ...next[idx] }; d.phase = p; next[idx] = d; return next; });
    }
    function changeDay(dir){ setIdx(cur => { let n = cur + dir; if (n < 0) n = days.length - 1; if (n >= days.length) n = 0; return n; }); }

    // Smart Coach (UI-only output; never writes into notes)
    const [coachText, setCoachText] = useState("");
    function analyzeFromNotes(){
      const text = (day.note || "").trim();
      if(!text){ setCoachText("Write a quick note, then tap Coach."); return; }
      const found = new Set(SYM_MATCHERS.filter(m=>m.rx.test(text)).map(m=>m.id));
      const mood = inferMoodFrom(text);
      const hits = COACH_RULES.filter(r=> found.has(r.id));
      const tips = hits.flatMap(h=>h.tips).slice(0,8);
      const moodBoost = (mood<=3)
        ? ["Youâ€™re not alone â€” make it gentle today.","Pick one tiny win now (8â€“10 oz water, 3 slow breaths).", COACH_AFFIRM[Math.floor(Math.random()*COACH_AFFIRM.length)]]
        : (mood<=6)
          ? ["Nice work staying steady. One small upgrade today.", COACH_AFFIRM[Math.floor(Math.random()*COACH_AFFIRM.length)]]
          : [COACH_AFFIRM[Math.floor(Math.random()*COACH_AFFIRM.length)], "Ride the wave, stay kind to yourself."];

      const header = found.size ? `I noticed: ${Array.from(found).join(", ")}.` : "No specific symptoms spotted â€” hereâ€™s a steady plan.";
      const body = tips.length ? ("Try these:\nâ€¢ " + tips.join("\nâ€¢ ")) : "Hydrate now, 5 slow breaths, short walk, then reassess.";
      setCoachText(`${header}\n\n${body}\n\n${moodBoost.join(" ")}`);
    }

    return e(React.Fragment, null,
      // masthead
      e("div",{className:"mast card"},
        e("div",{className:"mastRow"},
          e("div",{className:"mastLeft"},
            e("img",{src:"oz.png",alt:"Oz"}),
            e("div",{className:"mastTitle"},
              e("b",null,"Oz Companion"),
              e("small",null, day.phase.toUpperCase())
            )
          ),
          e("div",{className:"day-nav"},
            e("button",{className:"day-btn",onClick:()=>changeDay(-1),"aria-label":"Previous day"},"â—€"),
            e("span",{className:"day-label"},"Day "+day.day),
            e("button",{className:"day-btn",onClick:()=>changeDay(1),"aria-label":"Next day"},"â–¶")
          )
        ),
        e("div",{className:"mastRow",style:{marginTop:8}},
          e("select",{value:day.phase,onChange:(ev)=>setPhase(ev.target.value),className:"phaseSel","aria-label":"Phase"},
            e("option",{value:"fast"},"Fast"),
            e("option",{value:"cleanse"},"Cleanse"),
            e("option",{value:"rebuild"},"Rebuild")
          )
        )
      ),

      // progress
      e(ProgressBar,{value:progress}),

      // checklist (paw)
      e(Checklist,{items, state:checks, onToggle:toggleCheck}),

      // notes + coach (coach output stays in UI only)
      e("div",{className:"card",style:{marginTop:16}},
        e("h2",null,"Daily Notes"),
        e("div",{className:"coachShell",style:{marginTop:6}},
          e("div",{className:"coachHeader"},
            e("div",{className:"coachBadge"},"ðŸ§  Smart Coach"),
            e("small",null,"Understands your note and suggests relief + motivation")
          ),
          e("div",{className:"coachBtns"},
            e("button",{className:"btn primary",onClick:analyzeFromNotes},"Coach")
          ),
          coachText && e("div",{className:"coachOut"}, coachText)
        ),
        e("textarea",{
          value: day.note || "",
          onChange:(ev)=>{
            const val = ev.target.value;
            setDays(prev=>{
              const next = prev.slice();
              const d = {...next[idx]};
              d.note = val;
              next[idx] = d;
              return next;
            });
          },
          rows:4,
          style:{width:"100%",resize:"vertical",border:"1px solid var(--line)",borderRadius:12,padding:"10px",fontSize:16,marginTop:10}
        })
      ),

      // weight
      e("div",{className:"card",style:{marginTop:16}},
        e("h2",null,"Weight"),
        e("div",{style:{display:"flex",alignItems:"center",gap:8,margin:"8px 0"}},
          e("label",null,"Todayâ€™s weight"),
          e("input",{
            type:"number", step:"0.1",
            value:(day.weight==null?"":day.weight),
            onChange:(ev)=>{
              const v = ev.target.value;
              setDays(prev=>{
                const next = prev.slice();
                const d = { ...next[idx] };
                d.weight = (v==="" ? null : Number(v));
                if (v !== "" && ((d.checks && "weight" in d.checks) || activeIds.indexOf("weight") !== -1)) {
                  const c = { ...(d.checks || {}) }; c.weight = true; d.checks = c;
                }
                next[idx] = d; return next;
              });
            },
            style:{width:120}
          }),
          e("span",{className:"badge"},"Day "+day.day)
        ),
        e(WeightChart,{series:weightSeries})
      )
    );
  };

  /* ------------------- App ------------------- */
  const App = () => {
    const [settings, setSettings] = useLocal("oz.settings", { phaseTemplates: DEFAULT_PHASE_TEMPLATES });
    useEffect(()=>{  // guard bad local storage
      const pt=settings&&settings.phaseTemplates;
      const valid=pt&&["fast","cleanse","rebuild"].every(k=> Array.isArray(pt[k]) && pt[k].every(id=>!!GOAL_LIBRARY[id]));
      if(!valid) setSettings({ phaseTemplates: DEFAULT_PHASE_TEMPLATES });
      // eslint-disable-next-line react-hooks/exhaustive-deps
    },[]);
    const [days, setDays] = useLocal("oz.days", defaultDays());
    const [tab, setTab] = useState("dash");

    return e("div",{},
      tab==="dash" && e(Dashboard,{templates:settings.phaseTemplates, days, setDays}),

      e("div",{className:"tabs"},
        e("button",{className:"btn"+(tab==="dash"?" active":""),onClick:()=>setTab("dash")},"Dashboard"),
        e("button",{className:"btn",onClick:()=>alert('Groceries moved out for brevity')},"Groceries"),
        e("button",{className:"btn",onClick:()=>alert('Calendar moved out for brevity')},"Calendar"),
        e("button",{className:"btn",onClick:()=>alert('Photos moved out for brevity')},"Photos"),
        e("button",{className:"btn",onClick:()=>alert('Settings moved out for brevity')},"Settings")
      )
    );
  };

  ReactDOM.createRoot(document.getElementById("root")).render(e(App));
  </script>
</body>
</html>
