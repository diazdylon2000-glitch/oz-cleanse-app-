<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Oz Cleanse Companion ‚Äî V14+</title>
  <meta name="theme-color" content="#f9c2a7"/>

  <!-- React + Chart.js + Confetti -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- V14 look & feel -->
  <style>
    :root{
      --peach:#ffb08f; --peach-200:#ffd8c8; --peach-100:#fff1ea;
      --rose:#ec4899; --ink:#334155; --line:#f3d0e1; --chip:#ffe4ef;
      --cream:#fff7f1; --shadow:0 8px 24px rgba(236,72,153,.08);
    }
    *{box-sizing:border-box}
    /* Splash with Oz + speech bubble */
.splash{position:fixed;inset:0;background:#fef3ec;display:flex;align-items:center;justify-content:center;z-index:80}
.splash img{width:170px;height:170px;border-radius:9999px;object-fit:cover;border:6px solid #fff;box-shadow:0 24px 60px rgba(149,92,51,.25)}
.bubble{position:fixed;left:50%;top:54%;transform:translateX(92px);max-width:260px;z-index:81;background:#fff;border:2px solid #f3d0e1;border-radius:16px;box-shadow:0 10px 32px rgba(236,72,153,.15);padding:10px 12px;font-size:13px;line-height:1.25}
.bubble:after{content:'';position:absolute;left:-10px;top:28px;border:10px solid transparent;border-right-color:#f3d0e1}
.bubble:before{content:'';position:absolute;left:-8px;top:28px;border:10px solid transparent;border-right-color:#fff;z-index:1}
.fadeOut{animation:fadeOut .6s ease forwards}
@keyframes fadeOut{to{opacity:0;visibility:hidden}}

    /* Pretty dashboard masthead */
.mast{position:relative;border:1px solid var(--line);border-radius:16px;padding:12px;background:linear-gradient(90deg,#fff7f1,#ffe9e0)}
.mastRow{display:flex;align-items:center;justify-content:space-between;gap:12px}
.mastLeft{display:flex;align-items:center;gap:10px}
.mastLeft img{height:40px;width:40px;border-radius:9999px;object-fit:cover;border:2px solid #fff}
.mastTitle{display:flex;flex-direction:column}
.mastTitle b{font-size:18px;line-height:1}
.mastTitle small{color:#64748b}
    html,body{margin:0;background:var(--cream);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2{margin:0 0 8px 0}
    .wrap{max-width:940px;margin:16px auto 96px;padding:0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .badge{display:inline-block;padding:2px 10px;border:1px solid #e7ccd7;background:#fff;border-radius:9999px;font-size:12px}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer}
    .btn.peach{background:linear-gradient(90deg,#ffc7a9,#ffe1d6);border-color:#ffd9c8}
    .tabs{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:8px;background:#fff;border-top:1px solid var(--line)}
    .tabs .btn{flex:1}
    .tabs .btn.active{background:var(--chip)}
    .toast{position:fixed;left:12px;right:12px;top:18px;z-index:60}
    .toast>div{background:linear-gradient(90deg,#ffe4ef,#e9d5ff);border:1px solid var(--line);border-radius:16px;padding:10px;box-shadow:0 12px 30px rgba(236,72,153,.15)}
    .snack{position:fixed;left:12px;right:12px;bottom:16px;z-index:70}
    .snack>div{background:#1f2937;color:#fff;border-radius:14px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
    .pill{border-radius:9999px;padding:.45rem .8rem;border:1px solid #ffd8be;background:#fff;transition:transform .12s}
    .pill.on{background:linear-gradient(90deg,#ffc79d,#ffd8be)}
    .paw{display:inline-flex;align-items:center;justify-content:center;height:36px;width:36px;border-radius:9999px;border:1px solid #f0cbb0;background:#fff;transition:transform .12s, background .2s;cursor:pointer}
    .paw.on{background:linear-gradient(90deg,#f9d49a,#ffd2c8);transform:scale(1.02)}
    .prog{height:10px;border-radius:9999px;background:#fde7e0;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#ffa56e,#ec4899);width:0;transition:width .35s ease}
    header.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header.hdr img{height:36px;width:36px;border-radius:9999px;object-fit:cover}
    #errorBanner{display:none;position:fixed;top:0;left:0;right:0;background:#ff4d4d;color:#fff;padding:10px;font-size:14px;z-index:10000;text-align:center}
  </style>
</head>
<body>
  <div id="errorBanner"></div>
  <div id="ozSplash" class="splash"><img id="ozImg" alt="Oz" src="oz.png"/></div>
<div id="ozBubble" class="bubble">Hydration is happiness üêæ</div>
  <div id="root"></div>
  
<script>
(function(){
  // pick a friendly line each load
  var A=["You‚Äôve got this!","Oz is proud of you üê∂","Small habits, big change","Sip, breathe, reset","Progress, not perfection"];
  var b=document.getElementById("ozBubble"); if(b) b.textContent=A[Math.floor(Math.random()*A.length)];
  // fade out after load
  window.addEventListener("load",function(){
    setTimeout(function(){
      var s=document.getElementById("ozSplash"), bb=document.getElementById("ozBubble");
      if(s) s.classList.add("fadeOut"); if(bb) bb.classList.add("fadeOut");
      setTimeout(function(){ if(s) s.style.display="none"; if(bb) bb.style.display="none"; }, 620);
    }, 1100);
  });
})();
</script>
  <!-- React App -->
  <script>
  "use strict";
  const e = React.createElement;
  const { useState, useEffect } = React;

  /* ---------- helpers ---------- */
  function useLocal(key, initialValue){
    const [val, setVal] = React.useState(() => {
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
      catch { return initialValue; }
    });
    React.useEffect(() => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }, [key, val]);
    return [val, setVal];
  }
  window.addEventListener('error',function(e){
    var el=document.getElementById('errorBanner');
    el.textContent='Error: '+(e.error&&e.error.message?e.error.message:e.message);
    el.style.display='block';
  });

  /* ---------- data ---------- */
  const GOAL_LIBRARY = {
    water:"üíß Drink 120‚Äì150 oz water",
    tea:"üçµ Tea",
    coffee:"‚òï Coffee",
    juice:"üßÉ Juices",
    lmnt:"üßÇ LMNT Electrolytes",
    exercise:"üèÉ Exercise",
    wholefood:"ü•ó Whole food meals",
    weight:"üë£ Weight check-in"
  };

  const DEFAULT_PHASE_TEMPLATES = {
    fast:["water","tea","coffee","lmnt","exercise","weight"],
    cleanse:["water","tea","coffee","juice","lmnt","exercise","weight"],
    rebuild:["water","lmnt","exercise","wholefood","weight"]
  };

  function defaultDays(){
    const phases=["fast","fast","fast","cleanse","cleanse","cleanse","cleanse","rebuild","rebuild","rebuild","rebuild"];
    return phases.map((ph,i)=>({day:i+1,phase:ph,order:null,checks:{},custom:false,note:"",weight:null}));
  }

  // Recipes
  const PLAN_RECIPES = [
    { id:"r-melon", name:"Melon Mint Morning", type:"juice", day:4,
      ingredients:[{key:"melons",name:"Melon",qty:"1"},{key:"mint",name:"Mint",qty:"1/2 cup"},{key:"limes",name:"Lime",qty:"1"}],
      steps:"Juice melon ‚Üí mint ‚Üí lime."
    },
    { id:"r-peach", name:"Peachy Green Glow", type:"juice", day:5,
      ingredients:[{key:"peaches",name:"Peaches",qty:"6"},{key:"cucumbers",name:"Cucumbers",qty:"4"},{key:"spinach",name:"Spinach",qty:"8 cups"},{key:"lemons",name:"Lemons",qty:"2"}],
      steps:"Juice greens first."
    },
    { id:"r-carrot", name:"Carrot Apple Ginger", type:"juice", day:6,
      ingredients:[{key:"carrots",name:"Carrots",qty:'28'},{key:"apples",name:"Apples",qty:"4"},{key:"ginger",name:"Ginger",qty:'2"'},{key:"lemons",name:"Lemons",qty:"2"}],
      steps:"Juice, finish with lemon."
    },
    { id:"r-grape", name:"Grape Romaine Cooler", type:"juice", day:7,
      ingredients:[{key:"grapes",name:"Grapes",qty:"6 cups"},{key:"romaine",name:"Romaine",qty:"6 cups"},{key:"cucumbers",name:"Cucumbers",qty:"4"},{key:"lemons",name:"Lemons",qty:"2"}],
      steps:"Romaine ‚Üí cukes ‚Üí grapes ‚Üí lemon."
    },
    { id:"r-smoothie", name:"Smoothie Breakfast", type:"meal", day:8,
      ingredients:[{key:"spinach",name:"Spinach",qty:"2 cups"},{key:"almond-milk",name:"Almond milk",qty:"1 cup"},{key:"chia",name:"Chia",qty:"1 tbsp"}],
      steps:"Blend until smooth."
    },
    { id:"r-lentil", name:"Lentil Soup", type:"meal", day:8,
      ingredients:[{key:"lentils",name:"Lentils (dry)",qty:"1/2 cup"},{key:"carrots",name:"Carrots",qty:"1/2 cup"},{key:"celery",name:"Celery",qty:"1/2 cup"},{key:"parsley",name:"Parsley",qty:"1/4 cup"},{key:"onions",name:"Onion",qty:"1/4"}],
      steps:"Simmer ~25 min."
    },
    { id:"r-oats", name:"Overnight Oats", type:"meal", day:10,
      ingredients:[{key:"rolled-oats",name:"Rolled oats",qty:"1/2 cup"},{key:"almond-milk",name:"Almond milk",qty:"1 cup"}],
      steps:"Combine and chill."
    },
    { id:"r-quinoa", name:"Quinoa Salad", type:"meal", day:10,
      ingredients:[{key:"quinoa",name:"Quinoa (dry)",qty:"1/2 cup"},{key:"cucumbers",name:"Cucumber",qty:"1"},{key:"tomatoes",name:"Tomato",qty:"1"},{key:"parsley",name:"Parsley",qty:"1/4 cup"},{key:"olive-oil",name:"Olive oil",qty:"1 tbsp"},{key:"lemons",name:"Lemon",qty:"1"}],
      steps:"Toss; season."
    },
    { id:"r-protein", name:"Protein + Broccoli", type:"meal", day:11,
      ingredients:[{key:"protein",name:"Salmon/Chicken",qty:"12 oz"},{key:"broccoli",name:"Broccoli",qty:"2 heads"}],
      steps:"Cook protein; steam broccoli."
    }
  ];

  function aggregateGroceries(recipes){
    const map = {};
    recipes.forEach(r=>{
      (r.ingredients||[]).forEach(it=>{
        const id=(it.key||it.name||"").toLowerCase().replace(/\s+/g,'-');
        if(!map[id]){
          map[id]={id,name:it.name,qty:it.qty||"",checked:false,estCost:null,days:r.day?[r.day]:[]};
        }else{
          const s=new Set(map[id].days||[]);
          if(r.day) s.add(r.day);
          map[id].days=Array.from(s).sort((a,b)=>a-b);
        }
      });
    });
    return Object.values(map).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  }

  /* ---------- small components ---------- */
  const ProgressBar = ({ value }) =>
    e("div", { className:"prog" }, e("div", { className:"fill", style:{ width: Math.max(0, Math.min(100, value))+"%" } }));

  const Checklist = ({ items, state, onToggle }) =>
    e("ul", { style:{ listStyle:"none", padding:0 } },
      items.map(it =>
        e("li", { key:it.id, style:{ margin:"8px 0", display:"flex", alignItems:"center" } },
          e("div", { className:"paw"+(state[it.id]?" on":""), onClick:()=>onToggle(it.id) }, "üêæ"),
          e("span", { style:{ marginLeft:8 } }, it.label)
        )
      )
    );

  const WeightChart = ({ series }) => {
    const canvasRef = React.useRef(null);
    const chartRef = React.useRef(null);
    useEffect(()=>{
      const ctx = canvasRef.current.getContext("2d");
      if(chartRef.current){ try{ chartRef.current.destroy(); }catch(e){} }
      chartRef.current = new Chart(ctx, {
        type:"line",
        data:{ labels: series.map((_,i)=>"Day "+(i+1)), datasets:[{ data:series, borderColor:"#ec4899", backgroundColor:"rgba(236,72,153,.15)", tension:.35, spanGaps:true, pointRadius:2 }] },
        options:{ responsive:true, plugins:{ legend:{ display:false }}, scales:{ y:{ ticks:{ callback:v=>v||"" } } }, animation:{ duration:200 } }
      });
      return ()=>{ try{ chartRef.current && chartRef.current.destroy(); }catch(e){} };
    }, [series]);
    return e("canvas", { ref:canvasRef, height:120 });
  };

  /* ---------- pages ---------- */
  const GroceryList = ({ groceries, setGroceries }) => {
    const totals = groceries.reduce((acc,g)=>{
      const price = g.estCost ? Number(g.estCost) : 0;
      if(g.checked) acc.checked += price; else acc.remaining += price;
      acc.total += price; return acc;
    }, {checked:0, remaining:0, total:0});

    function toggle(idx){ setGroceries(groceries.map((g,i)=> i===idx? Object.assign({},g,{checked:!g.checked}):g)); }
    function setPrice(idx,val){ const v = val===""? null: Number(val); setGroceries(groceries.map((g,i)=> i===idx? Object.assign({},g,{estCost:v}):g)); }
    function daysBadge(days){
      if(!days||!days.length) return "üì¶ Pantry";
      const min = Math.min.apply(null,days), max = Math.max.apply(null,days);
      return "üìÖ "+(min===max?("Day "+min):("Day "+min+"‚Äì"+max));
    }

    return e("div", { className:"wrap" },
      e("h1", null, "Groceries & Prices"),
      e("div", { style:{ fontSize:12, color:"#64748b", margin:"6px 0 12px" } },
        "Checked $", totals.checked.toFixed(2),
        " ‚Ä¢ Remaining $", totals.remaining.toFixed(2),
        " ‚Ä¢ Total $", totals.total.toFixed(2)
      ),
      e("ul", { style:{ listStyle:"none", padding:0 }},
        groceries.map((g,idx)=>
          e("li", { key:g.id, style:{ display:"flex", alignItems:"center", gap:8, padding:"8px 0", borderBottom:"1px solid #f3d0e1" } },
            e("button", { className:"paw"+(g.checked?" on":""), onClick:()=>toggle(idx) }, g.checked?"üêæ":""),
            e("div", { style:{ flex:1 } },
              e("div", null, g.name, " ", e("span", { className:"badge" }, daysBadge(g.days))),
              e("div", { style:{ fontSize:12, color:"#64748b" } }, g.qty||"")
            ),
            e("input", { type:"number", step:"0.01", placeholder:"$", value:(g.estCost==null?"":g.estCost), onChange:(ev)=>setPrice(idx, ev.target.value), style:{ width:90 } })
          )
        )
      )
    );
  };

  const Calendar = ({ days, recipes, settings }) => {
    function dateFor(dayNum){
      const dstr = settings.phaseTemplates.__startDate || "";
      if(!dstr) return null;
      const base = new Date(dstr+"T00:00:00");
      if(isNaN(base)) return null;
      const dt = new Date(base.getTime() + (dayNum-1)*86400000);
      return dt.toLocaleDateString();
    }
    return e("div", { className:"wrap" },
      e("h1", null, "Calendar"),
      e("ul", { style:{ listStyle:"none", padding:0, marginTop:8 }},
        days.map(d=>{
          const dRecipes = recipes.filter(r=> r.day===d.day);
          const dd = dateFor(d.day);
          return e("li", { key:d.day, className:"card", style:{ marginBottom:8 }},
            e("div", { style:{ display:"flex", justifyContent:"space-between", alignItems:"center", gap:8 }},
              e("div", null,
                e("div", { style:{ fontWeight:600 } }, "Day ", d.day, " ‚Äî ", d.phase.toUpperCase()),
                dd && e("div", { className:"badge", style:{ marginTop:6 } }, dd)
              ),
              e("div", { style:{ display:"flex", gap:6, flexWrap:"wrap", minHeight:24 }},
                dRecipes.length ? dRecipes.map(r=> e("span", { key:r.id, className:"badge" }, (r.type==="juice"?"üßÉ ":"üçΩÔ∏è "), r.name)) :
                e("span", { style:{ fontSize:12, color:"#64748b" } }, "‚Äî")
              )
            )
          );
        })
      )
    );
  };

  const Photos = () => {
    const [photos, setPhotos] = useState([]);
    function handleUpload(ev){
      const files = Array.from(ev.target.files||[]);
      const urls = files.map(f=> URL.createObjectURL(f));
      setPhotos(photos.concat(urls));
      setTimeout(()=>{ alert("Looking strong ‚ú®"); }, 50);
    }
    return e("div", { className:"wrap" },
      e("h1", null, "Progress Photos"),
      e("input", { type:"file", multiple:true, accept:"image/*", onChange:handleUpload }),
      e("div", { style:{ display:"flex", gap:8, flexWrap:"wrap", marginTop:12 } },
        photos.map((url,i)=> e("img",{ key:i, src:url, style:{ width:100, height:100, objectFit:"cover", borderRadius:8 }}))
      )
    );
  };

  // Settings (phase templates + start date + import)
  const Settings = ({ templates, onChange, onImportPlan }) => {
    const [local, setLocal] = useState(templates);
    const [drag, setDrag] = useState({ phase:null, index:null });
    useEffect(()=>{ setLocal(templates); }, [templates]);

    function handleDragStart(phase, index, ev){ setDrag({phase,index}); try{ ev.dataTransfer.setData("text/plain", String(index)); }catch(e){} }
    function handleDrop(phase, index, ev){
      ev.preventDefault(); if(drag.phase!==phase || drag.index===null) return;
      const arr = (local[phase]||[]).slice(); const moved = arr.splice(drag.index,1)[0]; arr.splice(index,0,moved);
      const next = Object.assign({}, local); next[phase]=arr; setLocal(next); onChange(next); setDrag({phase:null,index:null});
    }
    function removeItem(phase, id){
      const arr = (local[phase]||[]).filter(x=>x!==id);
      const next = Object.assign({}, local); next[phase]=arr; setLocal(next); onChange(next);
    }
    function addItem(phase){
      const pool = Object.keys(GOAL_LIBRARY).filter(id=> (local[phase]||[]).indexOf(id)===-1);
      if(pool.length===0){ alert("All goals already included"); return; }
      const id = prompt("Add goal by ID:\n"+pool.join(", ")); if(!id || pool.indexOf(id)===-1) return;
      const next = Object.assign({}, local); next[phase]=(local[phase]||[]).concat([id]); setLocal(next); onChange(next);
    }
    function renderPhase(phase, label){
      const ids = local[phase]||[];
      return e("div",{className:"card",style:{marginBottom:16}},
        e("h2",null,label),
        e("ul",{style:{listStyle:"none",padding:0,marginTop:8}},
          ids.map((id,idx)=> e("li",{
              key:id, draggable:true,
              onDragStart:(ev)=>handleDragStart(phase,idx,ev),
              onDragOver:(ev)=>ev.preventDefault(),
              onDrop:(ev)=>handleDrop(phase,idx,ev),
              style:{display:"flex",alignItems:"center",padding:8,marginBottom:6,border:"1px solid #f3d0e1",borderRadius:12,background:"#fff"}
            },
            e("span",{style:{width:18,marginRight:8,opacity:.6}},"‚ãÆ‚ãÆ"),
            e("span",{style:{flex:1}},GOAL_LIBRARY[id]||id),
            e("button",{className:"btn",onClick:()=>removeItem(phase,id)},"Remove")
          ))
        ),
        e("div",null, e("button",{className:"btn peach",onClick:()=>addItem(phase)},"Add Goal"))
      );
    }

    return e("div",{className:"wrap"},
      e("h1",null,"Settings"),

      // Start Date
      e("div", { className:"card", style:{ marginBottom:16 }},
        e("h2", null, "Cleanse Start"),
        e("label", { style:{ fontSize:12, color:"#64748b" } }, "Start date"),
        e("input", {
          type:"date",
          value: (local.__startDate || ""),
          onChange: (ev)=>{
            const next = Object.assign({}, local, { __startDate: ev.target.value || "" });
            setLocal(next); onChange(next);
          },
          style:{ marginTop:6, padding:"8px", border:"1px solid #f3d0e1", borderRadius:"12px" }
        })
      ),

      e("p",{style:{margin:"6px 0 12px",color:"#64748b"}}, "Drag to reorder the default goals for each phase. These act as templates; individual days can still customize later."),
      renderPhase("fast","Fast ‚Äî Phase Template"),
      renderPhase("cleanse","Cleanse ‚Äî Phase Template"),
      renderPhase("rebuild","Rebuild ‚Äî Phase Template"),

      e("div",{className:"card",style:{marginTop:8}},
        e("h2",null,"Import 11-Day Plan"),
        e("p",{style:{color:"#64748b",margin:"6px 0 12px"}},"Loads all juices/meals and builds a tagged grocery list."),
        e("button",{className:"btn peach",onClick:onImportPlan},"Import Plan")
      )
    );
  };

// Dashboard
const Dashboard = ({ templates, days, setDays, recipes }) => {
  const [idx, setIdx] = React.useState(0);
  const { items: nextItems, label: nextLabel } = nextTwoDayIngredients(day);
  const templateIds = templates[day.phase] || [];
  const activeIds = (day.order && day.order.length ? day.order : templateIds);
  const items = activeIds.map(id => ({ id, label: GOAL_LIBRARY[id] || id }));
  const checks = day.checks || {};
  const doneCount = items.reduce((a, it) => a + (checks[it.id] ? 1 : 0), 0);
  const totalCount = Math.max(1, items.length);
  const progress = (doneCount / totalCount) * 100;
  const weightSeries = days.map(d => d.weight == null ? null : d.weight);

  // celebrate on 100%
  React.useEffect(() => {
    if (Math.round(progress) === 100 && window.confetti) {
      window.confetti({ particleCount: 80, spread: 70, origin: { y: .6 } });
      console.log(["Paw-some job! üêæ","You nailed it today! üí™","Oz is proud of you! üê∂","100% ‚Äî You‚Äôre unstoppable! üåü","Way to crush it! üéâ"][Math.floor(Math.random()*5)]);
    }
  }, [progress]);

  // helpers
function nextTwoDayIngredients(currentDay){
  // First try strict: today + tomorrow
  const tryDays = (d1, d2) => {
    const want = new Set([d1, d2]);
    const bag = {};
    (recipes || []).forEach(r => {
      if (!r.day || !want.has(r.day)) return;
      (r.ingredients || []).forEach(it => {
        const key = (it.key || it.name || "").toLowerCase();
        if (!bag[key]) bag[key] = { name: it.name, qtyList: [], days: new Set() };
        if (it.qty) bag[key].qtyList.push(it.qty);
        bag[key].days.add(r.day);
      });
    });
    Object.keys(bag).forEach(k => bag[k].days = Array.from(bag[k].days).sort((a,b)=>a-b));
    return Object.values(bag).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  };

  const strict = tryDays(currentDay.day, currentDay.day+1);
  if (strict.length) return { items: strict, label: nextLabel };

  // Fallback: find the next two future days that actually have recipes
  const futureDaysWithRecipes = Array.from(
    new Set((recipes||[]).filter(r => r.day >= currentDay.day).map(r => r.day))
  ).sort((a,b)=>a-b);

  const pool = futureDaysWithRecipes.slice(0,2);
  if (pool.length === 0) return { items: [], label: "Upcoming Ingredients" };

  const fallback = tryDays(pool[0], pool[1] || pool[0]);
  const label = pool.length === 2
    ? `Upcoming Ingredients ‚Äî Day ${pool[0]} & ${pool[1]}`
    : `Upcoming Ingredients ‚Äî Day ${pool[0]}`;
  return { items: fallback, label };
}

  const nextItems = nextTwoDayIngredients(day, true); // today + tomorrow

  function toggleCheck(id){
    setDays(prev => {
      const next = prev.slice();
      const d = { ...next[idx] };
      const c = { ...(d.checks || {}) };
      c[id] = !c[id];
      d.checks = c;
      next[idx] = d;
      return next;
    });
  }
  function setPhase(p){
    setDays(prev => {
      const next = prev.slice();
      const d = { ...next[idx] };
      d.phase = p;
      next[idx] = d;
      return next;
    });
  }
  function lmntQuickAdd(){
    if (activeIds.indexOf("lmnt") !== -1) { alert("LMNT is already on today‚Äôs checklist."); return; }
    setDays(prev => {
      const next = prev.slice();
      const d = { ...next[idx] };
      const base = (d.order && d.order.length ? d.order.slice() : templateIds.slice());
      base.push("lmnt");
      d.order = base; d.custom = true;
      const c = { ...(d.checks || {}) }; c.lmnt = false; d.checks = c;
      next[idx] = d;
      return next;
    });
  }
  const [editing, setEditing] = React.useState(false);
  const [dragIndex, setDragIndex] = React.useState(null);
  const [localIds, setLocalIds] = React.useState(activeIds);
  React.useEffect(() => { setLocalIds(activeIds); }, [idx, day.phase, day.order]);
  function applyCustom(){
    setDays(prev => {
      const next = prev.slice();
      const d = { ...next[idx] };
      d.order = localIds.slice();
      d.custom = true;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }
  function resetToTemplate(){
    setDays(prev => {
      const next = prev.slice();
      const d = { ...next[idx] };
      d.order = null; d.custom = false;
      const allowed = {}; (templates[d.phase] || []).forEach(g => allowed[g] = true);
      const nc = {};
      Object.keys(d.checks || {}).forEach(k => { if (allowed[k]) nc[k] = d.checks[k]; });
      d.checks = nc;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }
  function removeGoal(id){ setLocalIds(prev => prev.filter(x => x !== id)); }
  function addGoal(){
    const pool = Object.keys(GOAL_LIBRARY).filter(id => localIds.indexOf(id) === -1);
    if (pool.length === 0) { alert("All goals already included"); return; }
    const id = prompt("Add goal by ID:\n"+pool.join(", "));
    if (!id || pool.indexOf(id) === -1) return;
    setLocalIds(prev => prev.concat([id]));
  }
  function handleDragStart(i,ev){ setDragIndex(i); try{ ev.dataTransfer.setData("text/plain", String(i)); }catch(e){} }
  function handleDrop(i,ev){
    ev.preventDefault();
    if (dragIndex === null || dragIndex === i) return;
    setLocalIds(prev => { const arr = prev.slice(); const mv = arr.splice(dragIndex,1)[0]; arr.splice(i,0,mv); return arr; });
    setDragIndex(null);
  }
  function changeDay(dir){ setIdx(cur => { let n = cur + dir; if (n < 0) n = days.length - 1; if (n >= days.length) n = 0; return n; }); }

  return e(React.Fragment, null,

    // mast
    e("div",{className:"mast card"},
      e("div",{className:"mastRow"},
        e("div",{className:"mastLeft"},
          e("img",{src:"oz.png",alt:"Oz"}),
          e("div",{className:"mastTitle"},
            e("b",null,"Oz Cleanse Companion"),
            e("small",null,(day.custom ? "Custom ‚Ä¢ " : "Template ‚Ä¢ ") + day.phase.toUpperCase())
          )
        ),
        e("div",null,
          e("button",{className:"btn",onClick:()=>changeDay(-1)},"‚óÄ"),
          e("span",{className:"badge",style:{margin:"0 8px"}},"Day "+day.day),
          e("button",{className:"btn",onClick:()=>changeDay(1)},"‚ñ∂")
        )
      ),
      e("div",{className:"mastRow",style:{marginTop:8}},
        e("div",null,
          e("select",{value:day.phase,onChange:(ev)=>setPhase(ev.target.value),className:"btn"},
            e("option",{value:"fast"},"Fast"),
            e("option",{value:"cleanse"},"Cleanse"),
            e("option",{value:"rebuild"},"Rebuild")
          )
        ),
      )
    ),

    // progress
    e(ProgressBar,{value:progress}),

    // checklist
    e(Checklist,{items, state:checks, onToggle:toggleCheck}),

   // INGREDIENTS CARD
e("div",{className:"card",style:{marginTop:16}},
  e("h2", null, nextLabel),
  nextItems.length === 0
    ? e("p",{style:{color:"#64748b"}},"No recipes scheduled soon.")
    : e("ul",{style:{listStyle:"none",padding:0,marginTop:8}},
        nextItems.map(item =>
          e("li",{
              key:item.name,
              style:{
                display:"flex",
                justifyContent:"space-between",
                padding:"6px 0",
                borderBottom:"1px solid #f3d0e1"
              }
            },
            e("span", null,
              item.name, " ",
              e("span",{className:"badge"},
                item.days.length === 1
                  ? ("Day " + item.days[0])
                  : ("Day " + item.days[0] + "‚Äì" + item.days[item.days.length - 1])
              )
            ),
            e("span",{style:{color:"#64748b",fontSize:12}}, item.qtyList.join(" + ") || "")
          )
        )
      )
),
    // weight card
    e("div",{className:"card",style:{marginTop:16}},
      e("h2",null,"Weight"),
      e("div",{style:{display:"flex",alignItems:"center",gap:8,margin:"8px 0"}},
        e("label",null,"Today‚Äôs weight"),
        e("input",{
          type:"number", step:"0.1",
          value:(day.weight==null?"":day.weight),
          onChange:(ev)=>{
            const v = ev.target.value;
            setDays(prev=>{
              const next = prev.slice();
              const d = { ...next[idx] };
              d.weight = (v==="" ? null : Number(v));
              if (v !== "" && ((d.checks && "weight" in d.checks) || activeIds.indexOf("weight") !== -1)) {
                const c = { ...(d.checks || {}) }; c.weight = true; d.checks = c;
              }
              next[idx] = d;
              return next;
            });
          },
          style:{width:120}
        }),
        e("span",{className:"badge"},"Day "+day.day)
      ),
      e("div",{style:{marginTop:8}}, e(WeightChart,{series:weightSeries}))
    ),

    // editor
    editing && e("div",{className:"card",style:{marginTop:16,borderColor:"#f9c2a7"}},
      e("h2",null,"Customize Day "+day.day),
      e("p",{style:{color:"#64748b",margin:"6px 0 12px"}},"Drag to reorder; add/remove goals just for this day."),
      e("ul",{style:{listStyle:"none",padding:0}},
        localIds.map((id,i)=> e("li",{
            key:id,draggable:true,
            onDragStart:(ev)=>handleDragStart(i,ev),
            onDragOver:(ev)=>ev.preventDefault(),
            onDrop:(ev)=>handleDrop(i,ev),
            style:{display:"flex",alignItems:"center",padding:8,marginBottom:6,border:"1px solid #f3d0e1",borderRadius:12,background:"#fff"}
          },
          e("span",{style:{width:18,marginRight:8,opacity:.6}},"‚ãÆ‚ãÆ"),
          e("span",{style:{flex:1}},GOAL_LIBRARY[id]||id),
          e("button",{className:"btn",onClick:()=>removeGoal(id)},"Remove")
        ))
      ),
      e("div",null,
        e("button",{className:"btn peach",onClick:addGoal},"Add Goal"),
        e("button",{className:"btn",style:{marginLeft:8},onClick:()=>setEditing(false)},"Cancel"),
        e("button",{className:"btn",style:{marginLeft:8},onClick:applyCustom},"Save")
      )
    )
  );
};

  /* ---------- App ---------- */
  const App = () => {
    const [settings, setSettings] = useLocal("oz.settings", { phaseTemplates: DEFAULT_PHASE_TEMPLATES });
    useEffect(()=>{
      const pt=settings&&settings.phaseTemplates;
      const valid=pt&&["fast","cleanse","rebuild"].every(k=> Array.isArray(pt[k]) && pt[k].every(id=>!!GOAL_LIBRARY[id]));
      if(!valid) setSettings({ phaseTemplates: DEFAULT_PHASE_TEMPLATES });
    // eslint-disable-next-line react-hooks/exhaustive-deps
    },[]);
    const [days, setDays] = useLocal("oz.days", defaultDays());
   const [recipes, setRecipes] = useLocal("oz.recipes", PLAN_RECIPES);
const [groceries, setGroceries] = useLocal("oz.groceries", aggregateGroceries(PLAN_RECIPES));
    const [tab, setTab] = useState("dash");

    function importFullPlan(){
      const newDays = defaultDays(); setDays(newDays);
      setRecipes(PLAN_RECIPES);
      setGroceries(aggregateGroceries(PLAN_RECIPES));
      alert("Plan imported ‚úî");
    }

    return e("div", {},
  tab==="dash" && e(Dashboard, { templates: settings.phaseTemplates, days, setDays, recipes }),
      tab==="groceries" && e(GroceryList, { groceries, setGroceries }),
      tab==="calendar"  && e(Calendar, { days, recipes, settings }),
      tab==="photos"    && e(Photos),
      tab==="settings"  && e(Settings, {
        templates: settings.phaseTemplates,
        onChange: (next)=> setSettings({ phaseTemplates: next }),
        onImportPlan: importFullPlan
      }),

      e("div", { className:"tabs" },
        e("button",{className:"btn"+(tab==="dash"?" active":""),onClick:()=>setTab("dash")},"Dashboard"),
        e("button",{className:"btn"+(tab==="groceries"?" active":""),onClick:()=>setTab("groceries")},"Groceries"),
        e("button",{className:"btn"+(tab==="calendar"?" active":""),onClick:()=>setTab("calendar")},"Calendar"),
        e("button",{className:"btn"+(tab==="photos"?" active":""),onClick:()=>setTab("photos")},"Photos"),
        e("button",{className:"btn"+(tab==="settings"?" active":""),onClick:()=>setTab("settings")},"Settings")
      )
    );
  };

  ReactDOM.createRoot(document.getElementById("root")).render(e(App));
  </script>
</body>
</html>
