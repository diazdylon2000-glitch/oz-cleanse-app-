<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Oz Cleanse Companion ‚Äî V14</title>
  <meta name="theme-color" content="#f9c2a7"/>

  <!-- React + Chart.js with fallbacks (do not change) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"
          crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js'"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
          crossorigin
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"
          onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.3/dist/chart.umd.js'"></script>

  <!-- V14 look & feel -->
  <style>
    :root{
      --peach:#ffb08f; --peach-200:#ffd8c8; --peach-100:#fff1ea;
      --rose:#ec4899; --ink:#334155; --line:#f3d0e1; --chip:#ffe4ef;
      --cream:#fff7f1; --shadow:0 8px 24px rgba(236,72,153,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--cream);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2{margin:0 0 8px 0}
    .wrap{max-width:940px;margin:16px auto 96px;padding:0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .badge{display:inline-block;padding:2px 10px;border:1px solid #e7ccd7;background:#fff;border-radius:9999px;font-size:12px}
    .btn{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:14px;cursor:pointer}
    .btn.peach{background:linear-gradient(90deg,#ffc7a9,#ffe1d6);border-color:#ffd9c8}
    .grid{display:grid;gap:16px}
    @media(min-width:760px){.grid-3{grid-template-columns:repeat(3,1fr)}}

    /* Pills + paw checks */
    .pill{border-radius:9999px;padding:.45rem .8rem;border:1px solid #ffd8be;background:#fff;transition:transform .12s}
    .pill.on{background:linear-gradient(90deg,#ffc79d,#ffd8be)}
    .paw{display:inline-flex;align-items:center;justify-content:center;height:36px;width:36px;border-radius:9999px;border:1px solid #f0cbb0;background:#fff;transition:transform .12s, background .2s;cursor:pointer}
    .paw.on{background:linear-gradient(90deg,#f9d49a,#ffd2c8);transform:scale(1.02)}

    /* Progress bars */
    .prog{height:10px;border-radius:9999px;background:#fde7e0;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#ffa56e,#ec4899);width:0;transition:width .35s ease}

    /* Bottom tabs */
    .tabs{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:8px;background:#fff;border-top:1px solid var(--line)}
    .tabs .btn{flex:1}
    .tabs .btn.active{background:var(--chip)}

    /* Toast + snack */
    .toast{position:fixed;left:12px;right:12px;top:18px;z-index:60}
    .toast>div{background:linear-gradient(90deg,#ffe4ef,#e9d5ff);border:1px solid var(--line);border-radius:16px;padding:10px;box-shadow:0 12px 30px rgba(236,72,153,.15)}
    .snack{position:fixed;left:12px;right:12px;bottom:16px;z-index:70}
    .snack>div{background:#1f2937;color:#fff;border-radius:14px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}

    /* Splash with Oz + speech bubble */
    #errorBanner{display:none;position:fixed;top:0;left:0;right:0;background:#ff4d4d;color:#fff;padding:10px;font-size:14px;z-index:10000;text-align:center}
    .splash{position:fixed;inset:0;background:#fef3ec;display:flex;align-items:center;justify-content:center;z-index:80}
    .splash img{width:170px;height:170px;border-radius:9999px;object-fit:cover;border:6px solid #fff;box-shadow:0 24px 60px rgba(149,92,51,.25)}
    .bubble{position:fixed;left:50%;top:54%;transform:translateX(92px);max-width:260px;z-index:81;background:#fff;border:2px solid var(--line);border-radius:16px;box-shadow:0 10px 32px rgba(236,72,153,.15);padding:10px 12px;font-size:13px;line-height:1.25}
    .bubble:after{content:'';position:absolute;left:-10px;top:28px;border:10px solid transparent;border-right-color:var(--line)}
    .bubble:before{content:'';position:absolute;left:-8px;top:28px;border:10px solid transparent;border-right-color:#fff;z-index:1}
    .fadeOut{animation:fadeOut .6s ease forwards}
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}

    /* Header row */
    header.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header.hdr img{height:36px;width:36px;border-radius:9999px;object-fit:cover}
  </style>
</head>
<body>
  <!-- Error banner shows any JS crash with line:col -->
  <div id="errorBanner"></div>

  <!-- Splash -->
  <div id="ozSplash" class="splash"><img id="ozImg" alt="Oz"/></div>
  <div id="ozBubble" class="bubble">Loading‚Ä¶</div>

  <!-- App root -->
  <div id="root" style="display:none"></div>

  <!-- Splash failsafe + error capture -->
  <script>
    (function(){
      // Always hide splash after 3s even if React fails
      setTimeout(function(){
        var s=document.getElementById('ozSplash'); if(s) s.classList.add('fadeOut');
        var b=document.getElementById('ozBubble'); if(b) b.classList.add('fadeOut');
        setTimeout(function(){
          if(s) s.style.display='none';
          if(b) b.style.display='none';
          var root=document.getElementById('root'); if(root) root.style.display='block';
        },620);
      },3000);
      // Show errors on screen
      window.addEventListener('error',function(e){
        var el=document.getElementById('errorBanner');
        el.textContent='Error: '+(e.error&&e.error.message?e.error.message:e.message);
        el.style.display='block';
      });
    })();
  </script>

  <!-- Affirmations + Oz image init -->
  <script>
    (function(){
      try{
        var oz=document.getElementById('ozImg');
        oz.src='oz.png'; // replace with your real Oz photo filename later if different

        var A=[
          "You‚Äôve got this, one sip at a time!",
          "Strong body, strong mind‚Äîkeep going!",
          "Hydration is happiness. üêæ",
          "Fuel today, flourish tomorrow.",
          "Every sip is a promise kept.",
          "Gentle and steady wins.",
          "You‚Äôre lighter and brighter each day.",
          "Small habits, big change.",
          "Proud of you already.",
          "Your willpower is glowing.",
          "Keep moving; you‚Äôre unstoppable!",
          "Oz is rooting for you!",
          "Cleansing with kindness.",
          "Sip, breathe, reset.",
          "You crave what nourishes you.",
          "Consistency over intensity.",
          "You‚Äôre building momentum.",
          "Energy rising, mind clear.",
          "Hydrate like a champ.",
          "Today‚Äôs choices shape tomorrow.",
          "Progress, not perfection.",
          "Tiny wins stack up.",
          "You‚Äôre doing amazing.",
          "Cheers to your health.",
          "Own your routine.",
          "Steady heart, steady steps.",
          "Let it be simple.",
          "Flow with it; you‚Äôre good.",
          "Trust your pace.",
          "Shine from within."
        ];
        // Cycle without repeats
        var used=JSON.parse(localStorage.getItem('oz_aff_used')||'[]');
        var avail=A.filter(function(t){return used.indexOf(t)===-1;});
        if(avail.length===0){avail=A;used=[];}
        var pick=avail[Math.floor(Math.random()*avail.length)];
        used.push(pick); localStorage.setItem('oz_aff_used',JSON.stringify(used));
        var bubble=document.getElementById('ozBubble'); if(bubble) bubble.textContent=pick;
      }catch(err){
        var el=document.getElementById('errorBanner');
        el.textContent='Init error: '+err.message;
        el.style.display='block';
      }
      // Hide splash a bit earlier when window fully loads
      window.addEventListener('load',function(){
        setTimeout(function(){
          var s=document.getElementById('ozSplash'); var b=document.getElementById('ozBubble');
          if(s) s.classList.add('fadeOut'); if(b) b.classList.add('fadeOut');
          setTimeout(function(){
            if(s) s.style.display='none'; if(b) b.style.display='none';
            var root=document.getElementById('root'); if(root) root.style.display='block';
          },620);
        },1400);
      });
    })();
  </script>
<!-- React App (clean, fixed) -->
<script>
"use strict";

const e = React.createElement;
const { useState, useEffect } = React;

/* ---------- helpers & data ---------- */
function useLocal(key, initialValue){
  const [val, setVal] = React.useState(() => {
    try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initialValue; }
    catch { return initialValue; }
  });
  React.useEffect(() => {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }, [key, val]);
  return [val, setVal];
}

// Goal library
const GOAL_LIBRARY = {
  water:  "üíß Drink 120‚Äì150 oz water",
  tea:    "üçµ Tea",
  coffee: "‚òï Coffee",
  juice:  "üßÉ Juices",
  lmnt:   "üßÇ LMNT Electrolytes",
  exercise:"üèÉ Exercise",
  wholefood:"ü•ó Whole food meals",
  weight:"üë£ Weight check-in"
};

// Phase templates (defaults)
const DEFAULT_PHASE_TEMPLATES = {
  fast:    ["water","tea","coffee","lmnt","exercise","weight"],
  cleanse: ["water","tea","coffee","juice","lmnt","exercise","weight"],
  rebuild: ["water","lmnt","exercise","wholefood","weight"]
};

// Default 11-day plan
function defaultDays(){
  var phases=["fast","fast","fast","cleanse","cleanse","cleanse","cleanse","rebuild","rebuild","rebuild","rebuild"];
  var out=[];
  for(var i=0;i<phases.length;i++){
    out.push({
      day: i+1,
      phase: phases[i],
      order: null,      // null = use template; array = custom order
      checks: {},       // { goalId: boolean }
      custom: false,    // badge
      note: "",
      weight: null
    });
  }
  return out;
}

/* ---------- small UI pieces ---------- */
const ProgressBar = ({ value }) =>
  e("div", { className: "prog" },
    e("div", { className: "fill", style: { width: Math.max(0, Math.min(100, value)) + "%" } })
  );

const Checklist = ({ items, state, onToggle }) =>
  e("ul", { style: { listStyle: "none", padding: 0 } },
    items.map(it =>
      e("li", { key: it.id, style: { margin: "8px 0", display: "flex", alignItems: "center" } },
        e("div", {
          className: "paw" + (state[it.id] ? " on" : ""),
          onClick: () => onToggle(it.id)
        }, "üêæ"),
        e("span", { style: { marginLeft: 8 } }, it.label)
      )
    )
  );

// Chart.js mini weight chart
const WeightChart = ({ series }) => {
  const canvasRef = React.useRef(null);
  const chartRef = React.useRef(null);

  useEffect(() => {
    const ctx = canvasRef.current.getContext("2d");
    if (chartRef.current) { try { chartRef.current.destroy(); } catch(e){} }

    chartRef.current = new Chart(ctx, {
      type: "line",
      data: {
        labels: series.map((_, i) => "Day " + (i + 1)),
        datasets: [{
          data: series,
          borderColor: "#ec4899",
          backgroundColor: "rgba(236,72,153,.15)",
          tension: 0.35, spanGaps: true, pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { ticks: { callback: v => v || "" } } },
        animation: { duration: 200 }
      }
    });

    return () => { try { chartRef.current && chartRef.current.destroy(); } catch(e){} };
  }, [series]);

  return e("canvas", { ref: canvasRef, height: 120 });
};

/* ---------- pages ---------- */

// Simple grocery mock (you can replace later)
const GroceryList = ({ items }) => {
  const [checked, setChecked] = useState({});
  const total = items.reduce((sum, it) => sum + (checked[it.name] ? 0 : it.price), 0);
  return e("div", { className:"wrap" },
    e("h1", null, "Groceries"),
    e("div", { style: { fontWeight: "bold", marginBottom: 8 } }, "Total: $"+total.toFixed(2)),
    e("ul", { style: { listStyle: "none", padding: 0 } },
      items.map(it =>
        e("li", { key: it.name, style: { display: "flex", alignItems: "center", margin: "6px 0" } },
          e("input", {
            type: "checkbox",
            checked: !!checked[it.name],
            onChange: () => setChecked({ ...checked, [it.name]: !checked[it.name] })
          }),
          e("span", { style: { flex: 1, marginLeft: 8 } }, it.name+" ‚Äî Day "+it.day),
          e("span", { style: { fontSize: ".85em", color: "#666" } }, "$"+it.price.toFixed(2))
        )
      )
    )
  );
};

const Calendar = () => e("div", { className: "wrap" }, e("h1", null, "Calendar View"));

const Photos = () => {
  const [photos, setPhotos] = useState([]);
  function handleUpload(ev){
    var files = Array.from(ev.target.files||[]);
    var urls = files.map(function(f){ return URL.createObjectURL(f); });
    setPhotos(photos.concat(urls));
  }
  return e("div", { className: "wrap" },
    e("h1", null, "Progress Photos"),
    e("input", { type: "file", multiple: true, onChange: handleUpload }),
    e("div", { style: { display: "flex", gap: 8, flexWrap: "wrap", marginTop: 12 } },
      photos.map((url, i) =>
        e("img", { key: i, src: url, style: { width: 100, height: 100, objectFit: "cover", borderRadius: 8 } })
      )
    )
  );
};

// Settings: drag to reorder default goals per phase
const Settings = ({ templates, onChange }) => {
  const [local, setLocal] = useState(templates);
  const [drag, setDrag] = useState({ phase: null, index: null });

  useEffect(() => { setLocal(templates); }, [templates]);

  function handleDragStart(phase, index, e){
    setDrag({ phase, index });
    try { e.dataTransfer.setData("text/plain", String(index)); } catch {}
  }
  function handleDrop(phase, index, e){
    e.preventDefault();
    if (drag.phase !== phase || drag.index === null) return;
    var arr = local[phase].slice();
    var moved = arr.splice(drag.index, 1)[0];
    arr.splice(index, 0, moved);
    var next = Object.assign({}, local); next[phase] = arr;
    setLocal(next); onChange(next);
    setDrag({ phase: null, index: null });
  }
  function removeItem(phase, id){
    var arr = (local[phase]||[]).filter(function(x){ return x!==id; });
    var next = Object.assign({}, local); next[phase] = arr;
    setLocal(next); onChange(next);
  }
  function addItem(phase){
    var pool = Object.keys(GOAL_LIBRARY).filter(function(id){ return (local[phase]||[]).indexOf(id)===-1; });
    if (pool.length===0){ alert("All goals already included"); return; }
    var id = prompt("Add goal by ID:\n"+pool.join(", "));
    if(!id || pool.indexOf(id)===-1) return;
    var next = Object.assign({}, local); next[phase] = (local[phase]||[]).concat([id]);
    setLocal(next); onChange(next);
  }

  function renderPhase(phase, label){
    var ids = local[phase] || [];
    return e("div", { className:"card", style:{ marginBottom:16 }},
      e("h2", null, label),
      e("ul", { style:{ listStyle:"none", padding:0, marginTop:8 }},
        ids.map(function(id, idx){
          return e("li", {
            key:id, draggable:true,
            onDragStart:function(ev){ handleDragStart(phase, idx, ev); },
            onDragOver:function(ev){ ev.preventDefault(); },
            onDrop:function(ev){ handleDrop(phase, idx, ev); },
            style:{ display:"flex", alignItems:"center", padding:8, marginBottom:6, border:"1px solid #f3d0e1", borderRadius:12, background:"#fff" }
          },
            e("span", { style:{ width:18, marginRight:8, opacity:.6 } }, "‚ãÆ‚ãÆ"),
            e("span", { style:{ flex:1 } }, GOAL_LIBRARY[id] || id),
            e("button", { className:"btn", onClick:function(){ removeItem(phase, id); } }, "Remove")
          );
        })
      ),
      e("div", null,
        e("button", { className:"btn peach", onClick:function(){ addItem(phase); } }, "Add Goal")
      )
    );
  }

  return e("div", { className:"wrap" },
    e("h1", null, "Settings"),
    e("p", { style:{ margin:"6px 0 12px", color:"#64748b" } }, "Drag to reorder the default goals for each phase. These act as templates; individual days can still customize later."),
    renderPhase("fast", "Fast ‚Äî Phase Template"),
    renderPhase("cleanse", "Cleanse ‚Äî Phase Template"),
    renderPhase("rebuild", "Rebuild ‚Äî Phase Template")
  );
};

// Dashboard ‚Äî per-day customization + progress from real goals
const Dashboard = ({ templates, days, setDays }) => {
  const [idx, setIdx] = useState(0); // current day index (0-based)

  // Current day and computed lists
  const day = days[idx] || days[0];
  const templateIds = templates[day.phase] || [];
  const activeIds = (day.order && day.order.length ? day.order : templateIds);

  // Build UI items
  const items = activeIds.map(function(id){
    return { id:id, label: GOAL_LIBRARY[id] || id };
  });

// Progress math
const checks = day.checks || {};
const doneCount = items.reduce(function(acc, it){ return acc + (checks[it.id] ? 1 : 0); }, 0);
const totalCount = Math.max(1, items.length);
const progress = (doneCount / totalCount) * 100;

// Trigger celebration when 100%
useEffect(() => {
  if (progress === 100) {
    // Launch confetti (if canvas-confetti loaded)
    if (window.confetti) {
      window.confetti({
        particleCount: 80,
        spread: 70,
        origin: { y: 0.6 }
      });
    }
    // Random encouragement
    const phrases = [
      "Paw-some job! üêæ",
      "You nailed it today! üí™",
      "Oz is proud of you! üê∂",
      "100% ‚Äî You‚Äôre unstoppable! üåü",
      "Way to crush it! üéâ"
    ];
    alert(phrases[Math.floor(Math.random() * phrases.length)]);
  }
}, [progress]);
  
  // Weight series for mini chart
  const weightSeries = days.map(function(d){ return (d.weight==null ? null : d.weight); });

  function toggleCheck(id){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      var c = Object.assign({}, d.checks || {});
      c[id] = !c[id];
      d.checks = c;
      next[idx] = d;
      return next;
    });
  }

  function setPhase(p){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.phase = p;
      next[idx] = d;
      return next;
    });
  }

  function lmntQuickAdd(){
    if (activeIds.indexOf("lmnt") !== -1) {
      alert("LMNT is already on today‚Äôs checklist.");
      return;
    }
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      var base = (d.order && d.order.length ? d.order.slice() : templateIds.slice());
      base.push("lmnt");
      d.order = base;     
      d.custom = true;
      var c = Object.assign({}, d.checks || {});
      c.lmnt = false;
      d.checks = c;
      next[idx] = d;
      return next;
    });
  }

  const [editing, setEditing] = useState(false);
  const [dragIndex, setDragIndex] = useState(null);
  const [localIds, setLocalIds] = useState(activeIds);

  useEffect(function(){ setLocalIds(activeIds); }, [idx, day.phase, day.order]);

  function applyCustom(){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.order = localIds.slice();
      d.custom = true;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }

  function resetToTemplate(){
    setDays(function(prev){
      var next = prev.slice();
      var d = Object.assign({}, next[idx]);
      d.order = null;
      d.custom = false;
      var allowed = {};
      (templates[d.phase] || []).forEach(function(g){ allowed[g]=true; });
      var nc = {};
      Object.keys(d.checks || {}).forEach(function(k){ if(allowed[k]) nc[k]=d.checks[k]; });
      d.checks = nc;
      next[idx] = d;
      return next;
    });
    setEditing(false);
  }

  function removeGoal(id){
    setLocalIds(function(prev){ return prev.filter(function(x){ return x!==id; }); });
  }

  function addGoal(){
    var pool = Object.keys(GOAL_LIBRARY).filter(function(id){ return localIds.indexOf(id)===-1; });
    if(pool.length===0){ alert("All goals already included"); return; }
    var id = prompt("Add goal by ID:\n"+pool.join(", "));
    if(!id || pool.indexOf(id)===-1) return;
    setLocalIds(function(prev){ return prev.concat([id]); });
  }

  function handleDragStart(i,e){
    setDragIndex(i);
    try{ e.dataTransfer.setData("text/plain", String(i)); }catch(_){}
  }
  function handleDrop(i,e){
    e.preventDefault();
    if(dragIndex===null || dragIndex===i) return;
    setLocalIds(function(prev){
      var arr = prev.slice();
      var mv = arr.splice(dragIndex,1)[0];
      arr.splice(i,0,mv);
      return arr;
    });
    setDragIndex(null);
  }

  function changeDay(direction){
    setIdx(function(cur){
      var n = cur + direction;
      if(n<0) n = days.length-1;
      if(n>=days.length) n = 0;
      return n;
    });
  }

  return e("div", { className:"wrap" },
    e("header", { className:"hdr", style:{gap:8}},
      e("h1", null, "Dashboard"),
      e("div", { className:"badge" },
        (day.custom ? "Custom ‚Ä¢ " : "Template ‚Ä¢ ") + day.phase.toUpperCase()
      ),
      e("div", null,
        e("button", { className:"btn", onClick:function(){ changeDay(-1); } }, "‚óÄ"),
        e("span", { className:"badge", style:{margin:"0 8px"} }, "Day "+day.day),
        e("button", { className:"btn", onClick:function(){ changeDay(1); } }, "‚ñ∂")
      ),
      e("div", null,
        e("select", {
          value: day.phase,
          onChange:function(ev){ setPhase(ev.target.value); },
          className:"btn"
        },
          e("option", {value:"fast"}, "Fast"),
          e("option", {value:"cleanse"}, "Cleanse"),
          e("option", {value:"rebuild"}, "Rebuild")
        )
      ),
      e("div", null,
        e("button", { className:"btn peach", onClick:function(){ setEditing(true); } }, "Customize Day"),
        day.custom && e("button", { className:"btn", style:{marginLeft:8}, onClick:resetToTemplate }, "Reset to Template"),
        e("button", { className:"btn", style:{marginLeft:8}, onClick: lmntQuickAdd }, "Add LMNT Today")
      )
    ),

    e(ProgressBar, { value: progress }),

    e("ul", { style:{ listStyle:"none", padding:0, marginTop:12 }},
      items.map(function(it){
        var on = !!checks[it.id];
        return e("li", { key:it.id, style:{ display:"flex", alignItems:"center", margin:"8px 0" }},
          e("div", {
            className:"paw"+(on?" on":""),
            onClick:function(){ toggleCheck(it.id); }
          }, "üêæ"),
          e("span", { style:{ marginLeft:8 } }, it.label)
        );
      })
    ),

    // Weight card
    e("div", { className:"card", style:{ marginTop:16 }},
      e("h2", null, "Weight"),
      e("div", { style:{ display:"flex", alignItems:"center", gap:8, margin:"8px 0" } },
        e("label", null, "Today‚Äôs weight"),
        e("input", {
          type:"number",
          step:"0.1",
          value: (day.weight==null ? "" : day.weight),
          onChange: function(ev){
            var v = ev.target.value;
            setDays(function(prev){
              var next = prev.slice();
              var d = Object.assign({}, next[idx]);
              d.weight = (v==="" ? null : Number(v));

              // Auto-check "weight" goal if value entered
              if (v !== "" && ((d.checks && "weight" in d.checks) || activeIds.indexOf("weight") !== -1)) {
                var c = Object.assign({}, d.checks || {});
                c.weight = true;
                d.checks = c;
              }

              next[idx] = d;
              return next;
            });
          },
          style:{ width:120 }
        }),
        e("span", { className:"badge" }, "Day "+day.day)
      ),
      e("div", { style:{ marginTop:8 } },
        e(WeightChart, { series: weightSeries })
      )
    ),

    // Customization panel
    editing && e("div", { className:"card", style:{ marginTop:16, borderColor:"#f9c2a7" }},
      e("h2", null, "Customize Day "+day.day),
      e("p", { style:{ color:"#64748b", margin:"6px 0 12px" } }, "Drag to reorder; add/remove goals just for this day."),
      e("ul", { style:{ listStyle:"none", padding:0 }},
        localIds.map(function(id, i){
          return e("li", {
              key:id, draggable:true,
              onDragStart:function(e){ handleDragStart(i,e); },
              onDragOver:function(e){ e.preventDefault(); },
              onDrop:function(e){ handleDrop(i,e); },
              style:{ display:"flex", alignItems:"center", padding:"8px", marginBottom:"6px", border:"1px solid #f3d0e1", borderRadius:"12px", background:"#fff"}
            },
            e("span", { style:{ width:18, marginRight:8, opacity:.6 } }, "‚ãÆ‚ãÆ"),
            e("span", { style:{ flex:1 } }, GOAL_LIBRARY[id] || id),
            e("button", { className:"btn", onClick:function(){ removeGoal(id); } }, "Remove")
          );
        })
      ),
      e("div", null,
        e("button", { className:"btn peach", onClick:addGoal }, "Add Goal"),
        e("button", { className:"btn", style:{ marginLeft:8 }, onClick:function(){ setEditing(false); } }, "Cancel"),
        e("button", { className:"btn", style:{ marginLeft:8 }, onClick:applyCustom }, "Save")
      )
    )
  );
};
// ---- App ----
const App = () => {
  const [settings, setSettings] = useLocal("oz.settings", {
    phaseTemplates: DEFAULT_PHASE_TEMPLATES
  });

  // one-time template validation
  useEffect(() => {
    var pt = settings && settings.phaseTemplates;
    var valid = pt && ["fast","cleanse","rebuild"].every(function(k){
      return Array.isArray(pt[k]) && pt[k].every(function(id){ return !!GOAL_LIBRARY[id]; });
    });
    if(!valid) setSettings({ phaseTemplates: DEFAULT_PHASE_TEMPLATES });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const [days, setDays] = useLocal("oz.days", defaultDays());
  const [tab, setTab] = useState("dash");

  return e("div", {},
    tab === "dash" && e(Dashboard, { templates: settings.phaseTemplates, days: days, setDays: setDays }),
    tab === "groceries" && e(GroceryList, {
      items: [
        { name: "Carrots", day: 4, price: 2.5 },
        { name: "Spinach", day: 2, price: 3.0 },
        { name: "Apples", day: 1, price: 4.0 }
      ]
    }),
    tab === "calendar" && e(Calendar),
    tab === "photos" && e(Photos),
    tab === "settings" && e(Settings, {
      templates: settings.phaseTemplates,
      onChange: function(next){ setSettings({ phaseTemplates: next }); }
    }),

    e("div", { className: "tabs" },
      e("button", { className: "btn" + (tab === "dash" ? " active" : ""), onClick: function(){ setTab("dash"); } }, "Dashboard"),
      e("button", { className: "btn" + (tab === "groceries" ? " active" : ""), onClick: function(){ setTab("groceries"); } }, "Groceries"),
      e("button", { className: "btn" + (tab === "calendar" ? " active" : ""), onClick: function(){ setTab("calendar"); } }, "Calendar"),
      e("button", { className: "btn" + (tab === "photos" ? " active" : ""), onClick: function(){ setTab("photos"); } }, "Photos"),
      e("button", { className: "btn" + (tab === "settings" ? " active" : ""), onClick: function(){ setTab("settings"); } }, "Settings")
    )
  );
};

ReactDOM.render(e(App), document.getElementById("root"));
</script>
</body>
</html>
